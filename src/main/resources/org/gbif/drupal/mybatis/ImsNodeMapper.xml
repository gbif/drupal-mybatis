<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="org.gbif.drupal.mybatis.ImsNodeMapper">

  <!-- Auto-mapping and eager loading of sub resources  -->
  <resultMap id="NODE_MAP" type="Node" autoMapping="true">
    <id property="country" column="country"/>
    <result property="email" column="email" typeHandler="StringArrayTypeHandler"/>
    <result property="phone" column="phone" typeHandler="StringArrayTypeHandler"/>
    <result property="address" column="address" typeHandler="StringArrayTypeHandler"/>
    <result property="homepage" column="homepage" typeHandler="UriArrayTypeHandler"/>
    <result property="participantSince" column="participantSince" typeHandler="org.gbif.drupal.mybatis.ParticipantSinceTypeHandler"/>
    <collection property="contacts" column="imsId" select="listContacts"/>
  </resultMap>

  <!-- Auto-mapping and eager loading of sub resources  -->
  <resultMap id="CONTACT_MAP" type="Contact" autoMapping="true">
    <id property="key" column="cid"/>
    <result property="position" column="job_position" typeHandler="StringArrayTypeHandler"/>
    <result property="email" column="email" typeHandler="StringArrayTypeHandler"/>
    <result property="phone" column="phone" typeHandler="StringArrayTypeHandler"/>
    <result property="address" column="address" typeHandler="StringArrayTypeHandler"/>
    <result property="homepage" column="homepage" typeHandler="UriArrayTypeHandler"/>
  </resultMap>

  <select id="get" resultType="Node" resultMap="NODE_MAP">
    SELECT
      p.participantID AS imsId,
      c.iso2 AS country,
      n.name_full AS title,
      p.name_full AS participantTitle,
      p.name_short AS abbreviation,
      n.url AS homepage,
      p.name_full AS participantTitle,
      p.member_as_of AS participantSince,
      p.public_description AS description,
      null AS modified,
      i.`name` AS organization,
      i.address AS address,
      i.city AS city,
      i.zip_code AS postalCode,
      i.state_province AS province,
      i.telephone AS phone,
      i.email AS email,
      p.gbif_membership,
      null AS Region,
      p.mou2012_date AS MOU2012_Date

    FROM gbif_ims_node n
      JOIN gbif_ims_participant p ON n.participantID = p.participantID
      LEFT JOIN gbif_ims_country c ON p.countryID = c.countryID
      LEFT JOIN gbif_ims_institution i ON p.institutionID = i.institutionID

    WHERE p.participantID = #{imsId}
  </select>

  <!--
   This SQL relies on stable group ids in the IMS !!!
   The groups denoted in the where filter represent:
     node staff
     voting participant
     associate country participant
     other associate participant
  -->
  <select id="listContacts" resultType="Contact" resultMap="CONTACT_MAP">
    SELECT
      cgrnp.contactID AS cid,
      gr.groupID AS GroupID,
      cgrnp.participantID AS ParticipantID,
      cgrnp.nodeID AS NodeID,
      c.first_name,
      c.last_name,
      gr.`name` AS type,
      c.address AS Address,
      c.city AS City,
      c.zip_code AS postalCode,
      cou.iso2 AS country,
      i.`name` AS organization,
      c.email_address AS email,
      c.phone_office AS phone,
      c.profile_url AS homepage,
      c.job_position AS job_position,
      c.job_description AS description,
      null AS created_by,
      null AS created,
      null AS modified_by,
      null AS modified
    FROM gbif_ims_node n
      JOIN gbif_ims_contact_group_role_node_participant cgrnp ON (n.participantID = cgrnp.participantID OR n.nodeID = cgrnp.nodeID)
      JOIN gbif_ims_contact c ON cgrnp.contactID = c.contactID
      JOIN gbif_ims_group_role gr ON cgrnp.group_role_ID = gr.group_role_ID
      JOIN gbif_ims_group g ON gr.groupID = g.groupID AND gr.groupID in (11,12,13,31)
      LEFT JOIN gbif_ims_country cou ON c.countryID_address = cou.countryID
      LEFT JOIN gbif_ims_institution i ON c.institutionID = i.institutionID
    WHERE cgrnp.active != 0
      AND (c.on_the_web IS NULL OR c.on_the_web != 0)
      AND n.participantID = #{imsId}
    ORDER BY 7,1
  </select>

</mapper>